<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ReefScan - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #status-box { position: relative; z-index: 1000; width: 100%; font-size: 1.1em; margin-bottom: 1rem; }
        .status-deploy { background: green; color: white; }
        .status-no-deploy { background: red; color: white; }
        .status-no-session { background: gray; color: white; }
        .readout { font-size: 1em; margin: 5px 0; }
        h3 { font-size: 1.5em; margin-bottom: 10px; }
        #map-container { padding-bottom: 100px; }
        .fixed-bottom-row {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            padding: 15px 0;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        #cluster-panel {
            max-height: 60vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .cluster-badge {
            width: 20px;
            height: 20px;
            display: inline-block;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        #download-selected {
            display: block;
        }
        #download-selected.hidden {
            display: none;
        }
        .gps-marker {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Map Legend (Top Right) -->
        <div id="map-legend" style="position: absolute; top: 18px; right: 28px; z-index: 2000;">
            <div class="card p-2" style="max-width:350px;">
                <strong>Legend:</strong>
                <div style="display:flex;align-items:center;gap:10px;">
                    <span style="display:inline-block;width:18px;height:18px;background:yellow;border-radius:50%;border:1px solid #ccc;margin-right:6px;"></span> Deploy
                    <span style="display:inline-block;width:18px;height:18px;background:green;border-radius:50%;border:1px solid #ccc;margin:0 6px;"></span> Coral
                    <span style="display:inline-block;width:18px;height:18px;background:red;border-radius:50%;border:1px solid #ccc;margin-left:6px;"></span> Don't Deploy
                </div>
            </div>
        </div>
        <!-- End Map Legend -->
        <div class="row">
            <div class="col-md-3">
                <div id="status-box" class="p-4 rounded shadow status-no-deploy">
                    <h3 id="status-text">DON'T DEPLOY</h3>
                    <div class="readout"><strong>Mission Time:</strong> <span id="mission-time">{{ stats.mission_time }}</span></div>
                    <div class="readout"><strong>Total Deployments:</strong> <span id="deploy-count">{{ stats.deploy_count }}</span></div>
                    <div class="readout"><strong>GPS Position:</strong> <span id="gps-pos">Loading...</span></div>
                    <div class="readout"><strong>GPS Status:</strong> <span id="gps-status">Acquiring...</span></div>
                    <div class="readout"><strong>Distance Travelled:</strong> <span id="distance">0 km</span></div>
                    <div class="readout"><strong>Speed:</strong> <span id="speed">0 km/h</span></div>
                    <div class="readout"><strong>Depth:</strong> <span id="depth">20 m</span></div>
                    <div class="readout"><strong>Ultrasonic Distance:</strong> <span id="ultrasonic-distance">{{ stats.ultrasonic_distance }} cm</span></div>
                </div>
                <div id="cluster-panel" class="p-3 bg-light rounded">
                    <h6>Clusters ({{ stats.blobs }})</h6>
                    <ul id="cluster-list" class="list-unstyled">
                        {% for info in cluster_info %}
                        <li class="mb-2 form-check">
                            <input class="form-check-input cluster-check" type="checkbox" data-cid="{{ info.cid }}" checked id="check-{{ info.cid }}">
                            <label class="form-check-label" for="check-{{ info.cid }}">
                                <span class="cluster-badge" style="background-color: {{ info.color }};"></span>
                                Cluster {{ info.cid }} ({{ info.size }} pts)
                                <br><small class="text-muted">Center: {{ info.center_lat }}, {{ info.center_lon }} | Area: {{ info.area_m2 }} mÂ²</small>
                            </label>
                        </li>
                        {% endfor %}
                    </ul>
                    <button id="download-selected" class="btn btn-success btn-sm w-100">Download Selected GPX</button>
                </div>
            </div>
            <div class="col-md-9">
                <div id="map-container">{{ map_html | safe }}</div>
            </div>
        </div>
        <div class="fixed-bottom-row">
            <div class="container">
                <div class="row">
                    <div class="col">
                        <h5>Summary</h5>
                        <p>Total Patches: {{ stats.total if 'total' in stats else 0 }}</p>
                        <p>Valid Blobs: {{ stats.blobs }}</p>
                        <a href="/history" class="btn btn-info me-2">View History</a>
                        <a href="/end_session" class="btn btn-secondary">End Session</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
    // Connect to Socket.IO early for immediate event reception
    console.log('Connecting to Socket.IO...');
    var socket = io();
    socket.on('connect', function() {
        console.log('Socket.IO connected!');
    });
    socket.on('disconnect', function() {
        console.log('Socket.IO disconnected!');
    });

    // Store latest GPS for optional replay on map ready
    window.latestGps = null;

    // Helper to update map (extracted for reuse) - now using direct marker
    function updateMapWithGps(data) {
        if (window.map && window.gpsMarker) {
            console.log('Updating map with GPS:', data.lat, data.lon);  // Debug log
            // Update GPS marker directly
            window.gpsMarker.setLatLng([data.lat, data.lon]);
            window.gpsMarker.getPopup().setContent(`GPS Position<br>Lat: ${data.lat}<br>Lon: ${data.lon}<br>Quality: ${data.qual}`);
            window.gpsMarker.openPopup();

            // Lazy init trail and add point (Leaflet LatLng is [lat, lon])
            if (!window.gpsTrail) {
                window.gpsTrail = L.polyline([], {color: '#3388ff', weight: 4, opacity: 0.8}).addTo(window.map);
                console.log('GPS trail initialized');
            }
            window.gpsTrail.addLatLng([data.lat, data.lon]);

            // Auto-pan to new position
            window.map.panTo([data.lat, data.lon], {animate: true, duration: 0.5});
        } else {
            console.log('Map or gpsMarker not ready yet for GPS update');
        }
    }

    // Ultrasonic update (independent of DOM/map)
    socket.on('ultrasonic_update', function(data) {
        var el = document.getElementById('ultrasonic-distance');
        if (el && data.distance !== undefined) {
            el.textContent = data.distance + ' cm';
        }
    });

    // Deploy event (independent)
    socket.on('deploy_event', function(data) {
        // Show info popup for deploy event
        var popup = document.createElement('div');
        popup.style.position = 'fixed';
        popup.style.top = '20px';
        popup.style.left = '50%';
        popup.style.transform = 'translateX(-50%)';
        popup.style.background = '#17a2b8';
        popup.style.color = 'white';
        popup.style.padding = '16px 32px';
        popup.style.borderRadius = '8px';
        popup.style.zIndex = 2000;
        popup.style.fontSize = '1.3em';
        popup.innerHTML = '<strong>' + data.message + '</strong><br>Distance: ' + data.distance + ' cm';
        document.body.appendChild(popup);
        setTimeout(function() {
            popup.remove();
        }, 2500);
        if (data.deploy_count !== undefined) {
            document.getElementById('deploy-count').textContent = data.deploy_count;
        }
    });

    // GPS position update - update UI always, map when ready
    socket.on('gps_position_update', function(data) {
        window.latestGps = data;  // Store for replay if map becomes ready later
        if (data.lat !== undefined && data.lon !== undefined) {
            // Always update UI elements immediately
            document.getElementById('gps-pos').textContent = data.lat.toFixed(6) + ', ' + data.lon.toFixed(6);
            document.getElementById('gps-status').textContent = `Qual: ${data.qual}, Sats: ${data.sats}, HDOP: ${data.hdop ? data.hdop.toFixed(2) : 'N/A'}`;
            const statusBox = document.getElementById('status-box');
            const statusText = document.getElementById('status-text');
            let statusClass = 'status-no-deploy';
            if (data.color === 'green') {
                statusClass = 'status-deploy';
            } else if (data.color === 'red') {
                statusClass = 'status-no-deploy';
            } else if (data.color === 'gray') {
                statusClass = 'status-no-session';
            }
            statusBox.className = `p-4 rounded shadow ${statusClass}`;
            statusText.textContent = data.status;
            document.getElementById('deploy-count').textContent = data.deploy_count;
            document.getElementById('depth').textContent = `${data.depth} m`;
            document.getElementById('distance').textContent = `${data.total_distance.toFixed(2)} km`;
            document.getElementById('speed').textContent = `${data.speed.toFixed(1)} km/h`;

            // Map updates only if map is ready
            updateMapWithGps(data);
        }
    });

    // Mission time update (independent)
    setInterval(() => {
        fetch('/api/mission_time').then((r) => {
            if (!r.ok) {
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            return r.json();
        }).then(data => {
            document.getElementById('mission-time').textContent = data.time;
        }).catch(err => {
            console.error('Time API Error:', err);
        });
    }, 1000);

    // Cluster selection and toggle JS (runs after DOM ready)
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        const checks = document.querySelectorAll('.cluster-check');
        const downloadBtn = document.getElementById('download-selected');

        function updateDownloadButton() {
            const selected = Array.from(checks).filter(c => c.checked).length;
            if (selected > 0) {
                downloadBtn.classList.remove('hidden');
                downloadBtn.disabled = false;
            } else {
                downloadBtn.classList.add('hidden');
                downloadBtn.disabled = true;
            }
        }

        // Initial check
        updateDownloadButton();

        // Wait for map to load before attaching toggles AND replaying any stored GPS
        const mapCheckInterval = setInterval(function() {
            if (window.map) {
                clearInterval(mapCheckInterval);
                console.log('Map loaded, attaching toggles and checking for GPS replay');
                
                // Replay latest GPS if stored (fixes timing issue)
                if (window.latestGps) {
                    console.log('Replaying stored GPS data');
                    updateMapWithGps(window.latestGps);
                    // Optional: Clear after replay to avoid duplicates on next update
                    window.latestGps = null;
                }
                
                attachToggleListeners();
            }
        }, 200);

        function attachToggleListeners() {
            checks.forEach(function(check) {
                check.addEventListener('change', function() {
                    const cid = this.dataset.cid;
                    const checked = this.checked;
                    // Find and toggle layer by name
                    if (window.map && window.map.eachLayer) {
                        function findAndToggle(layer) {
                            if (layer.options && layer.options.name === `Cluster ${cid}`) {
                                if (checked) {
                                    window.map.addLayer(layer);
                                } else {
                                    window.map.removeLayer(layer);
                                }
                                return true;
                            }
                            if (layer.getLayers && layer.getLayers().length > 0) {
                                for (let child of layer.getLayers()) {
                                    if (findAndToggle(child)) return true;
                                }
                            }
                            return false;
                        }
                        window.map.eachLayer(findAndToggle);
                    }
                    updateDownloadButton();
                });
            });
        }

        // Download handler
        downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const selected = Array.from(checks).filter(c => c.checked)
                .map(c => c.dataset.cid)
                .join(',');
            if (selected === '') {
                alert('Please select at least one cluster to download.');
                return;
            }
            // Prompt for file name
            let filename = prompt('Enter GPX file name (without extension):', '');
            if (!filename || filename.trim() === '') {
                // Default to date-time
                const now = new Date();
                const pad = n => n.toString().padStart(2, '0');
                filename = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
            }
            // Trigger download via query param
            window.location.href = `/download_gpx?selected=${selected}&filename=${encodeURIComponent(filename)}`;
        });
    });
    </script>
</body>
</html>